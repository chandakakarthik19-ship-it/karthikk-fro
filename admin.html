<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>

  <style>
    body { font-family: Arial; background:#f4f4f4; padding:20px; }
    .container { max-width:1100px; margin:auto; background:white; padding:20px; border-radius:8px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:8px; }
    th { background:#eee; }
    button { padding:8px 14px; border:none; background:#007bff; color:white; border-radius:4px; cursor:pointer; }
    button:hover { background:#0056b3; }
    select, input { padding:8px; width:200px; }
    
    #logout { float:right; background:#e74c3c; }
    #logout:hover { background:#c0392b; }

    /* Change password popup */
    #pwdPopup, #editPopup {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center;
    }
    .popupBox {
      background:white; padding:20px; border-radius:8px; width:300px;
    }

  </style>
</head>

<body>
<div class="container">

  <h1>Admin Dashboard  
    <button id="changePwdBtn" style="float:right;margin-left:10px;background:#27ae60;">Change Password</button>
    <button id="logout">Logout</button>
  </h1>

  <hr>

  <!-- Add Work -->
  <h3>Add Work Entry</h3>

  <label>Select Farmer:</label><br>
  <select id="farmerSelect" title="Select Farmer">
    <option value="">Choose</option>
  </select><br><br>

  <label>Work Type:</label><br>
  <select id="workType">
    <option value="">Choose</option>
    <option>దుక్కు</option>
    <option>లోడింగ్</option>
    <option>రోటావేటర్</option>
    <option>దమ్ము</option>
  </select><br><br>

  <label>Work Time (1 = 1hr, 1.30 = 1hr 30m):</label><br>
  <input id="minutes" placeholder="1 = 1 hr" /><br><br>

  <label>Rate per 60 min:</label><br>
  <input id="rate" type="number" /><br><br>

  <button id="addWork">Add Work</button>

  <hr>

  <!-- Work History -->
  <h3>Work History</h3>
  
  <label>Filter by Farmer:</label>
  <select id="farmerSelectFilter">
    <option value="">Select Farmer</option>
  </select>
  <button id="viewHistory">View Farmer History</button>

  <table id="worksTable">
    <thead>
      <tr>
        <th>Farmer</th>
        <th>Date</th>
        <th>Type</th>
        <th>Minutes</th>
        <th>Rate</th>
        <th>Total</th>
        <th>Paid</th>
        <th>Pay</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<!-- EDIT POPUP -->
<div id="editPopup">
  <div class="popupBox">
    <h3>Edit Work</h3>
    <label>Work Type:</label><br>
    <input id="editType"><br><br>

    <label>Minutes:</label><br>
    <input id="editMinutes"><br><br>

    <label>Rate per 60:</label><br>
    <input id="editRate"><br><br>

    <label>Payment Given:</label><br>
    <input id="editPaid"><br><br>

    <button onclick="saveEdit()">Save</button>
    <button onclick="closeEdit()">Cancel</button>
  </div>
</div>

<!-- PASSWORD POPUP -->
<div id="pwdPopup">
  <div class="popupBox">
    <h3>Change Password</h3>
    <label>Current Password:</label><br>
    <input id="oldPwd" type="password"><br><br>

    <label>New Password:</label><br>
    <input id="newPwd" type="password"><br><br>

    <button id="savePwd">Update</button>
    <button onclick="document.getElementById('pwdPopup').style.display='none'">Cancel</button>
  </div>
</div>

<script>
const API = "https://karthikkk-back.onrender.com/api";
function token(){ return localStorage.getItem("adminToken"); }

let editingWorkId = null;

// Convert input time to minutes
function convertToMinutes(t){
  if (!t.includes(".")) return Number(t) * 60;
  let [h,m] = t.split(".");
  if (m.length === 1) m = m + "0";
  return (Number(h)*60) + Number(m);
}

// Load farmers
async function loadFarmers(){
  const res = await fetch(API + "/admin/farmers", {
    headers: { Authorization: "Bearer " + token() }
  });
  const farmers = await res.json();

  const f1 = document.getElementById("farmerSelect");
  const f2 = document.getElementById("farmerSelectFilter");

  f1.innerHTML = '<option value="">Choose</option>';
  f2.innerHTML = '<option value="">Choose</option>';

  farmers.forEach(f=>{
    f1.innerHTML += `<option value="${f._id}">${f.name}</option>`;
    f2.innerHTML += `<option value="${f._id}">${f.name}</option>`;
  });
}

// Add Work
document.getElementById("addWork").addEventListener("click", async ()=>{
  const farmerId = farmerSelect.value;
  const workType = workType.value;
  const minutes = convertToMinutes(document.getElementById("minutes").value);
  const rate = Number(rate.value);

  await fetch(API + "/admin/work", {
    method:"POST",
    headers:{ "Content-Type":"application/json", Authorization:"Bearer " + token() },
    body: JSON.stringify({ farmerId, workType, minutes, ratePer60: rate })
  });

  alert("Work Added");
  loadWorks();
});

// Load Works
document.getElementById("farmerSelectFilter").addEventListener("change", loadWorks);

async function loadWorks(){
  const farmer = farmerSelectFilter.value;
  const tbody = document.querySelector("#worksTable tbody");
  tbody.innerHTML = "";

  if (!farmer) return;

  const res = await fetch(API + "/admin/work?farmerId="+farmer, {
    headers:{ Authorization:"Bearer "+token() }
  });
  const data = await res.json();

  let total = 0, paid = 0;

  data.forEach(w=>{
    total += w.totalAmount || 0;
    paid += w.paymentGiven || 0;

    tbody.innerHTML += `
      <tr>
        <td>${w.farmer?.name || "--"}</td>
        <td>${new Date(w.date).toLocaleDateString()}</td>
        <td>${w.workType}</td>
        <td>${w.minutes}</td>
        <td>${w.ratePer60}</td>
        <td>₹${w.totalAmount}</td>
        <td>₹${w.paymentGiven || 0}</td>

        <td>
          <input type="number" id="pay_${w._id}" placeholder="Amount">
          <button onclick="makePayment('${w._id}','${w.farmer?._id}')">Pay</button>
        </td>

        <td>
          <button onclick="edit('${w._id}','${w.workType}','${w.minutes}','${w.ratePer60}','${w.paymentGiven||0}')">Edit</button>
          <button onclick="delWork('${w._id}')">Delete</button>
        </td>
      </tr>
    `;
  });

  const balance = total - paid;

  tbody.innerHTML += `
      <tr>
        <td colspan="5"><strong>Totals</strong></td>
        <td><strong>₹${total}</strong></td>
        <td><strong>₹${paid}</strong></td>
        <td colspan="2"><strong>Balance: ₹${balance}</strong></td>
      </tr>`;
}

// Payment
async function makePayment(workId, farmerId){
  const amount = Number(document.getElementById("pay_"+workId).value);
  if (!amount || amount <= 0) return alert("Invalid amount");

  await fetch(API + "/admin/payment/" + farmerId, {
    method:"POST",
    headers:{ "Content-Type":"application/json", Authorization:"Bearer "+token() },
    body: JSON.stringify({ amount, workId })
  });

  alert("Payment Recorded");
  loadWorks();
}

// Edit work popup
function edit(id, type, minutes, rate, paid){
  editingWorkId = id;
  editType.value = type;
  editMinutes.value = minutes;
  editRate.value = rate;
  editPaid.value = paid;
  editPopup.style.display = "flex";
}

function closeEdit(){ editPopup.style.display = "none"; }

// Save Edit
async function saveEdit(){
  await fetch(API + "/admin/work/" + editingWorkId, {
    method:"PUT",
    headers:{ "Content-Type":"application/json", Authorization:"Bearer "+token() },
    body: JSON.stringify({
      workType: editType.value,
      minutes: Number(editMinutes.value),
      ratePer60: Number(editRate.value),
      paymentGiven: Number(editPaid.value)
    })
  });

  alert("Updated Successfully");
  closeEdit();
  loadWorks();
}

// Delete work
async function delWork(id){
  if (!confirm("Delete this entry?")) return;

  await fetch(API + "/admin/work/" + id, {
    method:"DELETE",
    headers:{ Authorization:"Bearer "+token() }
  });

  loadWorks();
}

// Logout
logout.addEventListener("click", ()=>{
  localStorage.removeItem("adminToken");
  location.href = "index.html";
});

// Change password popup
changePwdBtn.addEventListener("click", ()=>{
  pwdPopup.style.display = "flex";
});

document.getElementById("savePwd").addEventListener("click", async ()=>{
  const oldPassword = oldPwd.value.trim();
  const newPassword = newPwd.value.trim();

  const res = await fetch(API + "/auth/admin/change-password", {
    method:"POST",
    headers:{ "Content-Type":"application/json", Authorization:"Bearer "+token() },
    body: JSON.stringify({ oldPassword, newPassword })
  });

  const data = await res.json();

  alert(data.message || data.error);
  pwdPopup.style.display = "none";
});

window.addEventListener("DOMContentLoaded", loadFarmers);
</script>

</body>
</html>
