<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>

  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px; }
    .container { max-width: 1100px; margin:auto; background:white; padding:20px; border-radius:8px; }
    h1 { display:flex; justify-content:space-between; align-items:center; }

    .btn {
      padding:8px 14px;
      border:none;
      border-radius:5px;
      cursor:pointer;
      color:white;
      font-size:14px;
    }

    .bg-red { background:#e74c3c; }
    .bg-blue { background:#2980b9; }
    .bg-green { background:#27ae60; }
    .bg-purple { background:#8e44ad; }

    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#f0f0f0; }

    input, select {
      padding:8px; width:60%; margin-top:5px; margin-bottom:10px;
    }

    /* Popup background */
    #passPopup, #editPopup {
      display:none;
      position:fixed; top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      justify-content:center;
      align-items:center;
      z-index:2000;
    }

    .popupBox {
      background:white;
      padding:20px;
      border-radius:8px;
      width:300px;
    }
  </style>
</head>

<body>

<div class="container">
  
  <h1>
    Admin Dashboard
    <div>
      <button id="changePassBtn" class="btn bg-blue">Change Password</button>
      <button id="logout" class="btn bg-red" onclick="logout()">Logout</button>
    </div>
  </h1>

  <h3>Add Work Entry</h3>

  <label for="farmerSelect">Select Farmer:</label><br>
  <select id="farmerSelect" title="Select Farmer" aria-label="Select Farmer"></select><br>

  <label for="workType">Select Work Type:</label><br>
  <select id="workType" title="Select Work Type" aria-label="Select Work Type">
    <option value="">-- Select --</option>
    <option>దుక్కు</option>
    <option>లోడింగ్</option>
    <option>రోటావేటర్</option>
    <option>దమ్ము</option>
    <option>జొన్నలు</option>
    <option>వరిసేను ఆట</option>
    <option>గత్తం</option>
  </select><br>

  <label for="minutes">Work Time:</label><br>
  <input id="minutes" type="text" placeholder="1 = 1h, 1.25 = 1h25m" aria-label="Work time"><br>

  <label for="rate">Rate per 60 min:</label><br>
  <input id="rate" type="number" aria-label="Rate per 60 minutes"><br>

  <button id="addWork" class="btn bg-green">Add Work</button>

  <hr><br>

  <h3>All Work</h3>

  <label for="farmerSelectFilter">Filter Farmer:</label>
  <select id="farmerSelectFilter" title="Filter Farmer" aria-label="Filter Farmer"></select>

  <button id="viewHistory" class="btn bg-purple">View Farmer History</button>

  <table id="worksTable">
    <thead>
      <tr>
        <th>Farmer</th>
        <th>Date</th>
        <th>Work Type</th>
        <th>Minutes</th>
        <th>Rate</th>
        <th>Total</th>
        <th>Paid</th>
        <th>Pay</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<!-- Change Password Popup -->
<div id="passPopup">
  <div class="popupBox">
    <h3>Change Password</h3>

    <label>Current Password</label>
    <input id="currentPass" type="password" aria-label="Current Password">

    <label>New Password</label>
    <input id="newPass" type="password" aria-label="New Password">

    <button onclick="submitPasswordChange()" class="btn bg-green">Submit</button>
    <button onclick="closePass()" class="btn bg-red">Cancel</button>
  </div>
</div>

<!-- Edit Popup -->
<div id="editPopup">
  <div class="popupBox">
    <h3>Edit Work</h3>

    <label>Work Type</label>
    <input id="edit_workType" aria-label="Edit Work Type">

    <label>Minutes</label>
    <input id="edit_minutes" type="number" aria-label="Edit Minutes">

    <label>Rate</label>
    <input id="edit_rate" type="number" aria-label="Edit Rate">

    <label>Paid</label>
    <input id="edit_paid" type="number" aria-label="Edit Paid Amount">

    <button onclick="saveEdit()" class="btn bg-green">Save</button>
    <button onclick="closeEdit()" class="btn bg-red">Cancel</button>
  </div>
</div>

<script>
const API = "https://karthikkk-back.onrender.com/api";
function token(){ return localStorage.getItem("adminToken"); }

// =================== CHANGE PASSWORD =================== //
document.getElementById("changePassBtn").onclick = () => {
  document.getElementById("passPopup").style.display = "flex";
};

function closePass(){
  document.getElementById("passPopup").style.display = "none";
}

async function submitPasswordChange(){
  let currentPassword = document.getElementById("currentPass").value.trim();
  let newPassword = document.getElementById("newPass").value.trim();

  if(!currentPassword || !newPassword){
    alert("Enter both passwords");
    return;
  }

  const res = await fetch(API + "/admin/change-password", {
    method:"POST",
    headers:{ "Content-Type":"application/json", Authorization:"Bearer " + token() },
    body:JSON.stringify({ username:"admin", currentPassword, newPassword })
  });

  const data = await res.json();

  if(data.success){
    alert("Password Changed! Login Again.");
    localStorage.removeItem("adminToken");
    location.href = "index.html";
  } else {
    alert(data.error || "Failed to update password");
  }
}

// =================== LOAD FARMERS =================== //
async function loadFarmers(){
  const res = await fetch(API + "/admin/farmers", {
    headers:{ Authorization:"Bearer " + token() }
  });

  const list = await res.json();

  let sel = document.getElementById("farmerSelect");
  let filterSel = document.getElementById("farmerSelectFilter");

  sel.innerHTML = `<option value="">-- Select --</option>`;
  filterSel.innerHTML = `<option value="">-- Select --</option>`;

  list.forEach(f=>{
    sel.innerHTML += `<option value="${f._id}">${f.name}</option>`;
    filterSel.innerHTML += `<option value="${f._id}">${f.name}</option>`;
  });
}

document.getElementById("viewHistory").onclick = () => {
  const id = document.getElementById("farmerSelectFilter").value;
  if(!id) return alert("Select a farmer");
  localStorage.setItem("farmerId", id);
  location.href = "farmer.html";
};

// =================== ADD WORK =================== //
function convertToMinutes(str){
  if(!str.includes(".")) return Number(str) * 60;
  let [h,m]=str.split(".");
  if(m.length===1) m+="0";
  return Number(h)*60 + Number(m);
}

document.getElementById("addWork").onclick = async () => {
  const farmerId = document.getElementById("farmerSelect").value;
  const workType = document.getElementById("workType").value;
  const minutes = convertToMinutes(document.getElementById("minutes").value);
  const ratePer60 = Number(document.getElementById("rate").value);

  await fetch(API + "/admin/work", {
    method:"POST",
    headers:{ "Content-Type":"application/json", Authorization:"Bearer " + token() },
    body:JSON.stringify({ farmerId, workType, minutes, ratePer60 })
  });

  alert("Work Added");
  loadWorks();
};

// =================== LOAD WORKS (WITH TOTALS + BALANCE) =================== //
async function loadWorks(){
  const farmer = document.getElementById("farmerSelectFilter").value;
  const tbody = document.querySelector("#worksTable tbody");
  tbody.innerHTML = "";

  if(!farmer) return;

  const res = await fetch(API + "/admin/work?farmerId=" + farmer, {
    headers:{ Authorization:"Bearer " + token() }
  });

  const ws = await res.json();

  let totalAmount = 0, totalPaid = 0;

  ws.forEach(w=>{
    totalAmount += w.totalAmount || 0;
    totalPaid += w.paymentGiven || 0;

    tbody.innerHTML += `
      <tr>
        <td>${w.farmer?.name}</td>
        <td>${new Date(w.date).toLocaleDateString("en-IN")}</td>
        <td>${w.workType}</td>
        <td>${w.minutes}</td>
        <td>${w.ratePer60}</td>
        <td>₹${(w.totalAmount || 0).toFixed(2)}</td>
        <td>₹${(w.paymentGiven || 0).toFixed(2)}</td>

        <td>
          <input id="pay_${w._id}" type="number" placeholder="Amount">
          <button class="btn bg-green" onclick="makePayment('${w._id}','${w.farmer?._id}')">Pay</button>
        </td>

        <td>
          <button class="btn bg-blue" onclick="edit('${w._id}','${w.workType}','${w.minutes}','${w.ratePer60}','${w.paymentGiven||0}')">Edit</button>
          <button class="btn bg-red" onclick="delWork('${w._id}')">Delete</button>
        </td>
      </tr>
    `;
  });

  const balance = totalAmount - totalPaid;
  let color = balance > 0 ? "red" : "green";

  tbody.innerHTML += `
    <tr style="font-weight:bold; background:#fafafa;">
      <td colspan="5" style="text-align:right;">Totals:</td>
      <td>₹${totalAmount.toFixed(2)}</td>
      <td>₹${totalPaid.toFixed(2)}</td>
      <td colspan="2" style="color:${color};">Balance: ₹${balance.toFixed(2)}</td>
    </tr>
  `;
}

document.getElementById("farmerSelectFilter").onchange = loadWorks;

// =================== PAYMENT =================== //
async function makePayment(workId, farmerId){
  const amount = Number(document.getElementById("pay_"+workId).value);
  if(!amount) return alert("Enter amount");

  await fetch(API + "/admin/payment/" + farmerId, {
    method:"POST",
    headers:{ "Content-Type":"application/json", Authorization:"Bearer " + token() },
    body:JSON.stringify({ amount, workId })
  });

  alert("Payment added");
  loadWorks();
}

// =================== EDIT WORK =================== //
let editingId = null;

function edit(id, type, minutes, rate, paid){
  editingId = id;
  document.getElementById("edit_workType").value = type;
  document.getElementById("edit_minutes").value = minutes;
  document.getElementById("edit_rate").value = rate;
  document.getElementById("edit_paid").value = paid;
  document.getElementById("editPopup").style.display = "flex";
}

function closeEdit(){
  document.getElementById("editPopup").style.display = "none";
}

async function saveEdit(){
  const workType = document.getElementById("edit_workType").value;
  const minutes = Number(document.getElementById("edit_minutes").value);
  const ratePer60 = Number(document.getElementById("edit_rate").value);
  const paymentGiven = Number(document.getElementById("edit_paid").value);

  await fetch(API + "/admin/work/" + editingId, {
    method:"PUT",
    headers:{ "Content-Type":"application/json", Authorization:"Bearer " + token() },
    body:JSON.stringify({ workType, minutes, ratePer60, paymentGiven })
  });

  alert("Updated!");
  closeEdit();
  loadWorks();
}

// =================== DELETE WORK =================== //
async function delWork(id){
  if(!confirm("Delete this work?")) return;

  await fetch(API + "/admin/work/" + id, {
    method:"DELETE",
    headers:{ Authorization:"Bearer " + token() }
  });

  loadWorks();
}

// =================== LOGOUT =================== //
function logout(){
  localStorage.removeItem("adminToken");
  location.href = "index.html";
}

// =================== START =================== //
window.onload = loadFarmers;
</script>

</body>
</html>
