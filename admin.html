<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    /* Table styling */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align:left; }
    th { background: #f4f4f4; }

    /* Buttons */
    #logout { float: right; padding: 6px 12px; background: #e74c3c; color: white; border-radius: 4px; }
    #logout:hover { background: #c0392b; }

    #changePassBtn {
      margin-left: 20px;
      padding: 6px 12px;
      background: #3498db;
      color: white;
      border-radius: 4px;
    }

    /* Popup background */
    #passPopup, #editPopup {
      display:none;
      position:fixed; top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      justify-content:center;
      align-items:center;
      z-index:2000;
    }

    /* Popup box */
    .popupBox {
      background:white;
      padding:20px;
      border-radius:8px;
      width:300px;
    }

    input[type="number"], input[type="text"] { width: 100%; }
  </style>
</head>

<body>
  <div class="container">
    <h1>
      Admin Dashboard 
      <a id="changePassBtn">Change Password</a>
      <a href="index.html" id="logout">Logout</a>
    </h1>

    <div class="card">

      <h3>Add Work Entry</h3>

      <label for="farmerSelect"><strong>Select Farmer:</strong></label><br>
      <select id="farmerSelect" title="Select a farmer"></select><br>

      <label for="workType"><strong>Select Work Type:</strong></label><br>
      <select id="workType" title="Select Work Type">
        <option value="">-- Select Work Type --</option>
        <option>దుక్కు</option>
        <option>లోడింగ్</option>
        <option>రోటావేటర్</option>
        <option>దమ్ము</option>
        <option>జొన్నలు</option>
        <option>వరిసేను ఆట</option>
        <option>గత్తం</option>
      </select><br>

      <label for="minutes"><strong>Work Time (1 = 1 hour):</strong></label><br>
      <input id="minutes" type="text" placeholder="e.g. 1.25 → 1h 25m"><br>

      <label for="rate"><strong>Rate per Hour:</strong></label><br>
      <input id="rate" type="number" title="Enter hourly rate"><br>

      <button id="addWork">Add Work</button>

      <h3>All Work</h3>

      <label for="farmerSelectFilter"><strong>Filter by Farmer:</strong></label>
      <select id="farmerSelectFilter" title="Select Farmer to Filter"></select>

      <button id="viewHistory">View Farmer History</button>

      <table id="worksTable">
        <thead>
          <tr>
            <th>Farmer</th>
            <th>Date</th>
            <th>Work</th>
            <th>Minutes</th>
            <th>Rate</th>
            <th>Total</th>
            <th>Paid</th>
            <th>Pay</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

    </div>
  </div>

  <!-- CHANGE PASSWORD POPUP -->
  <div id="passPopup">
    <div class="popupBox">
      <h3>Change Password</h3>

      <label>Current Password</label>
      <input id="currentPass" type="password" placeholder="Enter current">

      <label>New Password</label>
      <input id="newPass" type="password" placeholder="Enter new">

      <button onclick="submitPasswordChange()">Submit</button>
      <button onclick="closePass()">Cancel</button>
    </div>
  </div>

<script>
const API = "https://karthikkk-back.onrender.com/api";
function token(){ return localStorage.getItem("adminToken"); }

// --------------------- CHANGE PASSWORD --------------------- //
document.getElementById("changePassBtn").addEventListener("click", () => {
  document.getElementById("passPopup").style.display = "flex";
});

function closePass(){
  document.getElementById("passPopup").style.display = "none";
}

async function submitPasswordChange(){
  let currentPassword = document.getElementById("currentPass").value;
  let newPassword = document.getElementById("newPass").value;

  if(!currentPassword || !newPassword){
    alert("Enter both passwords");
    return;
  }

  const res = await fetch(API + "/admin/change-password", {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer " + token()
    },
    body:JSON.stringify({
      username:"admin",
      currentPassword,
      newPassword
    })
  });

  const data = await res.json();

  if(data.success){
    alert("Password changed successfully!");
    localStorage.removeItem("adminToken");
    location.href = "index.html";
  } else {
    alert(data.error || "Error changing password");
  }
}

// --------------------- LOAD FARMERS ------------------------- //
async function loadFarmers(){
  const res = await fetch(API + "/admin/farmers", {
    headers:{ Authorization:"Bearer " + token() }
  });

  const list = await res.json();

  document.getElementById("farmerSelect").innerHTML =
    "<option value=''>-- Select --</option>" +
    list.map(f => `<option value="${f._id}">${f.name}</option>`).join("");

  document.getElementById("farmerSelectFilter").innerHTML =
    "<option value=''>-- Select --</option>" +
    list.map(f => `<option value="${f._id}">${f.name}</option>`).join("");
}

// --------------------- CONVERT TIME ------------------------- //
function convertToMinutes(str){
  if(!str.includes(".")) return Number(str) * 60;

  let [h, m] = str.split(".");
  if(m.length === 1) m = m + "0";
  return Number(h) * 60 + Number(m);
}

// --------------------- ADD WORK ----------------------------- //
document.getElementById("addWork").addEventListener("click", async ()=>{
  const farmerId = document.getElementById("farmerSelect").value;
  const workType = document.getElementById("workType").value;
  const minutes = convertToMinutes(document.getElementById("minutes").value);
  const ratePer60 = Number(document.getElementById("rate").value);

  const res = await fetch(API + "/admin/work", {
    method:"POST",
    headers:{ "Content-Type":"application/json", Authorization:"Bearer " + token() },
    body:JSON.stringify({ farmerId, workType, minutes, ratePer60 })
  });

  alert("Work added");
});

// --------------------- INITIAL LOAD ------------------------- //
window.addEventListener("DOMContentLoaded", loadFarmers);
</script>

</body>
</html>
