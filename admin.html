<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align:left; }
    th { background: #f4f4f4; }
    input[type="number"]{ width: 100px; }
    #logout {
      float: right;
      margin-top: 10px;
      padding: 6px 12px;
      background: #e74c3c;
      color: white;
      text-decoration: none;
      border-radius: 4px;
    }
    #logout:hover { background: #c0392b; }

    /* Edit popup */
    #editPopup {
      display:none; 
      position:fixed; 
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      justify-content:center; 
      align-items:center;
      z-index:1000;
    }
    #editBox {
      background:white; padding:20px; border-radius:8px; width:300px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Admin Dashboard <a href="index.html" id="logout">Logout</a></h1>

    <div class="card">

      <h3>Add Work Entry</h3>

      <label for="farmerSelect"><strong>Select Farmer:</strong></label><br>
      <select id="farmerSelect" title="Select Farmer">
        <option value="">choose</option>
      </select><br><br>

      <label for="workType"><strong>Select Work Type:</strong></label><br>
      <select id="workType" title="Select Work Type">
        <option value="">-- Select Work Type --</option>
        <option>దుక్కు</option>
        <option>లోడింగ్</option>
        <option>రోటావేటర్</option>
        <option> . </option>
        <option>దమ్ము</option>
        <option>జొన్నలు</option>
        <option>వరిసేను ఆట</option>
        <option>గత్తం</option>
      </select><br><br>

      <label for="minutes"><strong>Work Time:</strong></label><br>
      <input id="minutes" placeholder="1 = 1 hour, 1.25 = 1h 25m, .5 = 50m" type="text" /><br><br>

      <label for="rate"><strong>Rate per 60 min:</strong></label><br>
      <input id="rate" placeholder="Rate per 60" type="number" />

      <button id="addWork">Add Work</button>

      <br><br>
      <h3>All Work</h3>

      <label for="farmerSelectFilter"><strong>Filter by Farmer:</strong></label>
      <select id="farmerSelectFilter" title="Filter Farmer">
        <option value="">-- Select Farmer --</option>
      </select>

      <button id="viewHistory">View Farmer History</button>

      <div id="works">
        <table id="worksTable">
          <thead>
            <tr>
              <th>Farmer</th>
              <th>Date</th>
              <th>Work Type</th>
              <th>Minutes</th>
              <th>Rate per 60</th>
              <th>Total Amount</th>
              <th>Payment Given</th>
              <th>Make Payment</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>

<!-- =============== EDIT POPUP =============== -->
<div id="editPopup">
  <div id="editBox">
    <h3>Edit Work Entry</h3>

    <label>Work Type:</label><br>
    <input id="edit_workType" type="text"><br><br>

    <label>Minutes:</label><br>
    <input id="edit_minutes" type="number"><br><br>

    <label>Rate Per 60:</label><br>
    <input id="edit_rate" type="number"><br><br>

    <label>Payment Given:</label><br>
    <input id="edit_paid" type="number"><br><br>

    <button onclick="saveEdit()">Save</button>
    <button onclick="closeEdit()">Cancel</button>
  </div>
</div>

<script>
const API = "https://karthikkk-back.onrender.com/api";
function token(){ return localStorage.getItem('adminToken'); }
let editingWorkId = null;

// Load farmers
async function loadFarmers(){
  const res = await fetch(API + '/admin/farmers',
    { headers: { Authorization: 'Bearer ' + token() }});
  const list = await res.json();

  document.getElementById('farmerSelect').innerHTML =
    '<option value="">choose</option>' +
    list.map(f=>`<option value="${f._id}">${f.name} (${f.phone})</option>`).join('');

  document.getElementById('farmerSelectFilter').innerHTML =
    '<option value="">-- Select Farmer --</option>' +
    list.map(f=>`<option value="${f._id}">${f.name} (${f.phone})</option>`).join('');

  loadWorks();
}

document.getElementById('viewHistory').addEventListener('click', ()=>{
  const id = document.getElementById('farmerSelectFilter').value;
  if(!id) return alert('Select a farmer');
  localStorage.setItem('farmerId', id);
  location.href = 'farmer.html';
});


// ⭐ NEW RULE: 
// 1 → 1 hour (60 min)
// Whole numbers = hours
// Decimals = hours.minutes
function convertToMinutes(timeStr){
  // Whole number → treat as hours
  if (!timeStr.includes('.')) {
    const hours = Number(timeStr) || 0;
    return hours * 60;
  }

  const [h, m] = timeStr.split('.');
  const hours = Number(h) || 0;
  let minutesPart = m;

  // .5 → 50 min
  if (minutesPart.length === 1) minutesPart = minutesPart + "0";

  const minutes = Number(minutesPart) || 0;

  return hours * 60 + minutes;
}


// Add Work
document.getElementById('addWork').addEventListener('click', async ()=>{

  const farmerId = document.getElementById('farmerSelect').value;
  if(!farmerId) return alert('Select a farmer');

  const workType = document.getElementById('workType').value;
  if(!workType) return alert('Select work type');

  const minutes = convertToMinutes(document.getElementById('minutes').value.trim());
  if(minutes <= 0) return alert('Enter valid time');

  const ratePer60 = Number(document.getElementById('rate').value);
  if(!ratePer60 || ratePer60 <= 0) return alert('Enter valid rate');

  await fetch(API + '/admin/work', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', Authorization: 'Bearer ' + token() },
    body: JSON.stringify({ farmerId, workType, minutes, ratePer60 })
  });

  alert('Work Added');
  loadWorks();
});

// Load works
document.getElementById('farmerSelectFilter').addEventListener('change', loadWorks);

async function loadWorks(){
  const farmer = document.getElementById('farmerSelectFilter').value;

  const tbody = document.querySelector('#worksTable tbody');
  tbody.innerHTML = '';

  if(!farmer) return;

  const res = await fetch(API + '/admin/work?farmerId=' + farmer,
    { headers:{ Authorization: 'Bearer ' + token() }}
  );

  const ws = await res.json();
  let totalWork = 0, totalPaid = 0;

  ws.forEach(w=>{
    totalWork += w.totalAmount || 0;
    totalPaid += w.paymentGiven || 0;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${w.farmer?.name||'--'}</td>
      <td>${new Date(w.date).toLocaleDateString('en-IN')}</td>
      <td>${w.workType}</td>
      <td>${w.minutes}</td>
      <td>${w.ratePer60}</td>
      <td>₹${(w.totalAmount||0).toFixed(2)}</td>
      <td>₹${(w.paymentGiven||0).toFixed(2)}</td>

      <td>
        <input type="number" id="pay_${w._id}" placeholder="amount" />
        <button onclick="makePayment('${w._id}', '${w.farmer?._id||''}')">Pay</button>
      </td>

      <td>
        <button onclick="edit('${w._id}', '${w.workType}', '${w.minutes}', '${w.ratePer60}', '${w.paymentGiven || 0}')">Edit</button>
        <button onclick="delWork('${w._id}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  const balance = totalWork - totalPaid;

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td colspan="5"><strong>Totals</strong></td>
    <td><strong>₹${totalWork.toFixed(2)}</strong></td>
    <td><strong>₹${totalPaid.toFixed(2)}</strong></td>
    <td colspan="2"><strong>Balance: ₹${balance.toFixed(2)}</strong></td>
  `;
  tbody.appendChild(tr);
}

// Payment
window.makePayment = async function(workId, farmerId){
  const amt = Number(document.getElementById('pay_' + workId).value);
  if(!amt || amt <= 0) return alert('Enter valid amount');

  await fetch(API + '/admin/payment/' + farmerId, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token() },
    body: JSON.stringify({ amount: amt, workId })
  });

  alert('Payment recorded');
  loadWorks();
};

// ⭐ EDIT POPUP
window.edit = function(id, type, minutes, rate, paid){
  editingWorkId = id;

  document.getElementById("edit_workType").value = type;
  document.getElementById("edit_minutes").value = minutes;
  document.getElementById("edit_rate").value = rate;
  document.getElementById("edit_paid").value = paid;

  document.getElementById("editPopup").style.display = "flex";
};

function closeEdit(){
  document.getElementById("editPopup").style.display = "none";
}

// SAVE EDIT
async function saveEdit(){
  const workType = document.getElementById("edit_workType").value;
  const minutes = Number(document.getElementById("edit_minutes").value);
  const rate = Number(document.getElementById("edit_rate").value);
  const paid = Number(document.getElementById("edit_paid").value);

  await fetch(API + '/admin/work/' + editingWorkId, {
    method:"PUT",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer " + token()
    },
    body: JSON.stringify({ workType, minutes, ratePer60: rate, paymentGiven: paid })
  });

  alert("Updated Successfully");
  closeEdit();
  loadWorks();
}

// Delete
window.delWork = async function(id){
  if(!confirm('Delete work?')) return;

  await fetch(API + '/admin/work/' + id, {
    method:'DELETE',
    headers:{ Authorization: 'Bearer ' + token() }
  });

  loadWorks();
};

// Logout
document.getElementById('logout').addEventListener('click', ()=>{
  localStorage.removeItem('adminToken');
});

window.addEventListener('DOMContentLoaded', loadFarmers);
</script>

</body>
</html>
