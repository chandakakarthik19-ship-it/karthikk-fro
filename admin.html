<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>

  <link rel="stylesheet" href="admin.css">
</head>

<body>

<div class="container">

  <h1>Admin Dashboard</h1>
  <a id="logout" href="index.html">Logout</a>

  <button id="openPassPopup" class="pass-btn">Change Password</button>

  <hr>

  <h3>Add Work Entry</h3>

  <label for="farmerSelect">Select Farmer:</label>
  <select id="farmerSelect" title="Select Farmer">
    <option value="">Choose</option>
  </select>

  <label for="workType">Select Work Type:</label>
  <select id="workType" title="Select Work Type">
    <option value="">-- Select Work Type --</option>
    <option>దుక్కు</option>
    <option>లోడింగ్</option>
    <option>రోటావేటర్</option>
    <option>దమ్ము</option>
    <option>జొన్నలు</option>
    <option>వరిసేను ఆట</option>
    <option>గత్తం</option>
  </select>

  <label for="minutes">Work Time:</label>
  <input id="minutes" title="Enter work time" placeholder="1 = 1 hr, 1.25 = 1h 25m">

  <label for="rate">Rate per 60 min:</label>
  <input id="rate" type="number" title="Rate per 60 minutes" placeholder="Enter rate">

  <button id="addWork">Add Work</button>

  <hr>

  <h3>All Work</h3>

  <label for="farmerSelectFilter">Filter by Farmer:</label>
  <select id="farmerSelectFilter" title="Filter Farmer">
    <option value="">-- Select Farmer --</option>
  </select>

  <button id="viewHistory">View History</button>

  <table id="worksTable">
    <thead>
      <tr>
        <th>Farmer</th>
        <th>Date</th>
        <th>Work Type</th>
        <th>Minutes</th>
        <th>Rate</th>
        <th>Total</th>
        <th>Paid</th>
        <th>Payment</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<!-- CHANGE PASSWORD POPUP -->
<div id="passPopup" class="popup">
  <div class="popup-box">

    <h3>Change Password</h3>

    <label>Current Password:</label>
    <input id="currentPass" type="password" placeholder="Enter current password">

    <label>New Password:</label>
    <input id="newPass" type="password" placeholder="Enter new password">

    <button class="save-btn" onclick="submitPasswordChange()">Submit</button>
    <button class="cancel-btn" onclick="closePassPopup()">Cancel</button>

  </div>
</div>

<!-- EDIT WORK POPUP -->
<div id="editPopup" class="popup">
  <div class="popup-box">

    <h3>Edit Work Entry</h3>

    <label>Work Type:</label>
    <input id="edit_workType" type="text">

    <label>Minutes:</label>
    <input id="edit_minutes" type="number">

    <label>Rate Per 60:</label>
    <input id="edit_rate" type="number">

    <label>Payment Given:</label>
    <input id="edit_paid" type="number">

    <button class="save-btn" onclick="saveEdit()">Save</button>
    <button class="cancel-btn" onclick="closeEdit()">Cancel</button>

  </div>
</div>

<script>
const API = "https://karthikkk-back.onrender.com/api";
function token(){ return localStorage.getItem('adminToken'); }
let editingWorkId = null;

// ---------------- CHANGE PASSWORD POPUP ----------------

document.getElementById("openPassPopup").onclick = () => {
  document.getElementById("passPopup").style.display = "flex";
};

function closePassPopup(){
  document.getElementById("passPopup").style.display = "none";
}

async function submitPasswordChange() {
  const currentPassword = document.getElementById("currentPass").value.trim();
  const newPassword = document.getElementById("newPass").value.trim();

  if (!currentPassword || !newPassword) {
    alert("Enter both passwords.");
    return;
  }

  const res = await fetch(API + "/admin/change-password", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token()
    },
    body: JSON.stringify({
      username: "admin",
      currentPassword,
      newPassword
    })
  });

  const data = await res.json();

  if (data.success) {
    alert("Password changed! Login again.");
    localStorage.removeItem("adminToken");
    location.href = "index.html";
  } else {
    alert(data.error || "Failed");
  }
}

// ---------------- UTILITIES ----------------

function convertToMinutes(timeStr){
  if (!timeStr.includes('.')) return Number(timeStr) * 60;
  let [h, m] = timeStr.split('.');
  if (m.length === 1) m += "0";
  return (Number(h) * 60) + Number(m);
}

// ---------------- LOAD FARMERS ----------------

async function loadFarmers(){
  const res = await fetch(API + '/admin/farmers', {
    headers: { Authorization: 'Bearer ' + token() }
  });

  const list = await res.json();

  document.getElementById('farmerSelect').innerHTML =
    '<option value="">Choose</option>' +
    list.map(f=>`<option value="${f._id}">${f.name}</option>`).join('');

  document.getElementById('farmerSelectFilter').innerHTML =
    '<option value="">-- Select Farmer --</option>' +
    list.map(f=>`<option value="${f._id}">${f.name}</option>`).join('');
}

// ---------------- LOAD WORK ENTRIES ----------------

document.getElementById("farmerSelectFilter").addEventListener("change", loadWorks);

async function loadWorks(){
  const farmerId = document.getElementById('farmerSelectFilter').value;
  const tbody = document.querySelector("#worksTable tbody");
  tbody.innerHTML = "";

  if (!farmerId) return;

  const res = await fetch(API + '/admin/work?farmerId=' + farmerId, {
    headers: { Authorization: 'Bearer ' + token() }
  });

  const ws = await res.json();
  let totalWork = 0, totalPaid = 0;

  ws.forEach(w=>{
    totalWork += w.totalAmount || 0;
    totalPaid += w.paymentGiven || 0;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${w.farmer?.name}</td>
      <td>${new Date(w.date).toLocaleDateString()}</td>
      <td>${w.workType}</td>
      <td>${w.minutes}</td>
      <td>${w.ratePer60}</td>
      <td>₹${(w.totalAmount||0).toFixed(2)}</td>
      <td>₹${(w.paymentGiven||0).toFixed(2)}</td>

      <td>
        <input id="pay_${w._id}" type="number" placeholder="Amount">
        <button onclick="makePayment('${w._id}','${w.farmer._id}')">Pay</button>
      </td>

      <td>
        <button onclick="openEdit('${w._id}','${w.workType}','${w.minutes}','${w.ratePer60}','${w.paymentGiven||0}')">Edit</button>
        <button onclick="delWork('${w._id}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ---------------- ADD WORK ----------------

document.getElementById("addWork").addEventListener("click", async () => {
  const farmerId = document.getElementById("farmerSelect").value;
  const workType = document.getElementById("workType").value;
  const minutes = convertToMinutes(document.getElementById("minutes").value);
  const ratePer60 = Number(document.getElementById("rate").value);

  await fetch(API + "/admin/work", {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: "Bearer " + token() },
    body: JSON.stringify({ farmerId, workType, minutes, ratePer60 })
  });

  alert("Work Added!");
  loadWorks();
});

// ---------------- PAYMENT ----------------

async function makePayment(workId, farmerId){
  const amt = Number(document.getElementById("pay_"+workId).value);
  if (!amt) return alert("Enter amount");

  await fetch(API + '/admin/payment/' + farmerId, {
    method: "POST",
    headers:{ "Content-Type":"application/json", Authorization:"Bearer "+token() },
    body: JSON.stringify({ amount: amt, workId })
  });

  alert("Payment Added");
  loadWorks();
}

// ---------------- EDIT WORK ----------------

function openEdit(id, type, minutes, rate, paid) {
  editingWorkId = id;
  document.getElementById("edit_workType").value = type;
  document.getElementById("edit_minutes").value = minutes;
  document.getElementById("edit_rate").value = rate;
  document.getElementById("edit_paid").value = paid;

  document.getElementById("editPopup").style.display = "flex";
}

function closeEdit(){
  document.getElementById("editPopup").style.display = "none";
}

async function saveEdit(){
  const workType = document.getElementById("edit_workType").value;
  const minutes = Number(document.getElementById("edit_minutes").value);
  const rate = Number(document.getElementById("edit_rate").value);
  const paid = Number(document.getElementById("edit_paid").value);

  await fetch(API + '/admin/work/' + editingWorkId, {
    method:"PUT",
    headers:{ "Content-Type":"application/json", Authorization:"Bearer "+token() },
    body: JSON.stringify({ workType, minutes, ratePer60: rate, paymentGiven: paid })
  });

  alert("Work Updated");
  closeEdit();
  loadWorks();
}

// ---------------- DELETE WORK ----------------

async function delWork(id){
  if (!confirm("Delete work?")) return;

  await fetch(API + '/admin/work/' + id, {
    method:"DELETE",
    headers: { Authorization: "Bearer " + token() }
  });

  loadWorks();
}

// ---------------- START ----------------

window.onload = loadFarmers;

</script>

</body>
</html>
